---
title: "Demographic modification of gene expression in predicting  diffuse large B cell lymphoma (DLBCL) treatment response"
author: "cyy36@cam.ac.uk"
date: "`r Sys.Date()`"
# toc_float: yes
bibliography: references.bib
csl: nature.csl
link-citations: true
output:
  rmdformats::readthedown
  # html_document:
    # toc: yes
    # theme: default
    # pandoc_args : ["--citeproc"]
---

<style>
.figure-caption {
  font-size: 0.9em;
  color: #555;
  font-style: normal;
  margin-top: 10px;
  margin-bottom: 20px;
  padding: 8px 12px;
  background-color: #f8f9fa;
  border-left: 4px solid #dee2e6;
  border-radius: 0 4px 4px 0;
}
</style>

<center>
![](https://onlinecareeraccelerators.pace.cam.ac.uk/hubfs/CAM%20DS%20PACE/Professional%20and%20Continuing%20Education_V_reversed%20colour%201.svg)
</center>


<h3 style="text-align: center;">MSt Healthcare Data Science</h2>

#### Authentication of practice

|   |   |
|---|---|
|I confirm that I have fully read and understood the [assignment brief](https://vle.pace.cam.ac.uk/mod/page/view.php?id=2419694) for this module.| **Y** |

#### Details

|   |   |
|---|---|
|Name: Chung Yan|Surname: Yu|
|Submission Date| 19-10-25|
|Word Count: whole assignment including codes| |
|Word Count: main body excluding abstract, references and supplementary materials| |

#### Permission to share your assignment

I do give permission to share my assignment with future MSt participants.

#### University statement of originality

This assignment is the result of my own work and includes nothing which is the outcome of work done in collaboration except as declared in the Preface and specified in the text. It is not substantially the same as any that I have previously submitted for a degree or diploma or other qualification at the University of Cambridge or any other university or similar institution, or that is being concurrently submitted, except as declared in the Preface and specific in the text. I further state that no substantial part of my Portfolio has already been submitted, nor is being concurrently submitted for any such degree, diploma or other qualification at the University of Cambridge or any other university or similar institution except as declared in the Preface and specified in the text.

|   |   |
|---|---|
|I confirm the statement of originality as above| **Y** |


#### Questions for reflection

Self-assessment is an important aspect of feedback literacy, which is, in turn, key to the development of expertise. As you proceed through the MSt Healthcare data science programme, we hope that you will make use of the following prompts to assess your own work on assignments. Specific assignment briefs will likely indicate which of these to address for which assessments, but, in general, we expect you to respond to one or two for each assignment on your course. 

For each of the questions, do not spend too long answering – keep it brief. For each question you answer, limit yourself to no more than three items. And please remember, this is optional and developmental: these cover sheets are designed to create space for self-assessment and feedback dialogue, rather than additional assignment workload.

1. Which aspects of this assignment are you most uncertain about and/or would most like to receive feedback on?
2. What elements are you left pondering after this assignment that you would like to discuss further?
3. How have you incorporated feedback from peers and tutors into this assignment?
4. How, and to what extent, have you been able to incorporate feedback on previous course work into this assignment? 
5. Using the wording in the rubric, how would you describe the quality of the different aspects of your work?

### Declaration of the use of generative AI

|   |   |
|---|---|
|Which permitted use of generative AI are you acknowledging?|Semantic search of literature and notes, outline creation, code debugging, output formatting and generation, informed feedback|
|Which generative AI tool did you use (name and version)?|Claude Code v2.0.3x (the version likely changed over usage), Claude Desktop v1.0.3x with PubMed Connector, M365 CoPilot|
|What did you use the tool for?|Searching for relevant journal publications, sanity check on coding strategies, collating notes in my Obsidian vault, debugging code by parsing error messages|
|How have you used or changed the generative AI's output|E.g. my collated notes always stay in point form so that I write out the paragraphs in my own words. Feedback provided by the GenAI models are weighed and assessed before being acted on. Code generated are checked, e.g. it tried to run Levene test on a model fitted using residuals as the response, this was rectified back to the relevant response variable.|

# Abstract
Diffuse large B cell lymphoma (DLBCL) is the most common non-Hodgkin lymphoma, with prognosis influenced by demographic features (age, gender), integrated scoring systems such as the International Prognostic Index (IPI) and genetic alterations. Oncogenes MYC, BCL2, BCL6 emerged with strong DLBCL associations, and further studies have identified over 150 genetic drivers. Yet whether these genetic markers' effects differ across demographic subgroups remains understudied. This study analysed the gene expression data of 21 genes from 775 DLBCL patients to investigate whether age and gender modify gene expression-response associations. Hierarchical logistic regression models tested demographic-gene interactions across 21 genes and 2 demographic factors (age and gender, totalling 42). Only CCND2 showed significant interaction effects (Likelihood ratio test adjusted p = 0.006) with age on predicting complete response. Older age groups showed significant increase (61-75 odds ratio p = 0.014; >75 odds ratio p = 0.001) in complete response probability with higher CCND2 expression, while younger patients (≤40, 41-60) showed the opposite insignificant trend. Gender revealed no main or interaction effects across all genes. MYC showed significant prognostic effects (likelihood ratio test adjusted p = 0.010) with response completeness that were consistent across all demographic groups, with no interaction effects. With only 1 of 42 tested demographic-gene combinations demonstrating interaction effects, the demographic modifying effects remain a rare phenomenon amongst genetic markers examined. This supports existing models taking a more universal approach on prognostic thresholds for most genomic markers. The age-dependent effects of CCND2 could however provide a starting point to reconcile conflicting prognostic associations of CCND2 expression levels in existing literature, although further validation in other independent cohorts and mechanistic confirmation are required.

```{r setup, include=FALSE}
# Set chunk options: hide all code, outputs, messages, warnings, and errors
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      results = 'hide', error = FALSE)

# Suppress all output during package installation and loading
suppressMessages(suppressWarnings({

  # Package installation (silent)
  if(!require(tidyverse, quietly = TRUE)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
  if(!require(knitr, quietly = TRUE)) install.packages("knitr", repos = "http://cran.us.r-project.org")
  if(!require(DT, quietly = TRUE)) install.packages("DT", repos = "http://cran.us.r-project.org")
  if(!require(readxl, quietly = TRUE)) install.packages("readxl", repos = "http://cran.us.r-project.org")
  if(!require(httr, quietly = TRUE)) install.packages("httr", repos = "http://cran.us.r-project.org")
  if(!require(here, quietly = TRUE)) install.packages("here", repos = "http://cran.us.r-project.org")
  if(!require(kableExtra, quietly = TRUE)) install.packages("kableExtra", repos = "http://cran.us.r-project.org")
  if (!require(plotly, quietly = TRUE)) install.packages("plotly", repos = "http://cran.us.r-project.org")
  if (!require(multcompView, quietly = TRUE)) install.packages("multcompView", repos = "http://cran.us.r-project.org")
  if (!require(rstatix, quietly = TRUE)) install.packages("rstatix", repos = "http://cran.us.r-project.org")
  if (!require(broom, quietly = TRUE)) install.packages("broom", repos = "http://cran.us.r-project.org")
  if (!require(emmeans, quietly = TRUE)) install.packages("emmeans", repos = "http://cran.us.r-project.org")
  if (!require(RColorBrewer, quietly = TRUE)) install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")

  # Load packages (silent)
  library(tidyverse)
  library(knitr)
  library(DT)
  library(readxl)
  library(httr)
  library(here)
  library(kableExtra)
  library(plotly)
  library(multcompView)
  library(rstatix)
  library(broom)
  library(emmeans)
  library(RColorBrewer)

}))
```

# Introduction

```{r data-loading, cache = TRUE}
# Silent data loading with fallback mechanism
# Data source tracking for inline text reference

# Define data source URLs
# Default URL, direct from ScienceDirect
direct_url <- "https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx"
# Backup URL, from this GitHub repository
repo_url <- "https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc1-ClinicalInformation.csv"

# Initialise variables for tracking data source
clinical_data <- NULL
data_source_type <- ""  # For storing inline text reference on which URL was used

# Suppress all output during data loading
suppressMessages(suppressWarnings({

  # Attempt 1: Load from original ScienceDirect URL
  tryCatch({
    temp_file <- tempfile(fileext = ".xlsx")
    download.file(direct_url, temp_file, mode = "wb", quiet = TRUE)

    # Verify file downloaded and is readable
    if (file.exists(temp_file) && file.size(temp_file) > 0) {
      clinical_data <- read_excel(temp_file, sheet = "Clinical Information", skip = 3)

      # Verify data loaded properly, i.e. matches known dimensions
      if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
        data_source_type <- "original"
      } else {
        stop("Wrong dimensions in the ScienceDirect data for clinical information dataset") # Corresponds to the dimension check
      }
    } else {
      stop("Clinical information from Table S1 failed to download") # Corresponds to the file exist and file size != 0 check
    }

  }, error = function(e) {
    clinical_data <<- NULL  # Ensure NULL for fallback
  })

  # Attempt 2: Fallback to processed backup dataset
  if (is.null(clinical_data)) {
    tryCatch({
      clinical_data <- read_csv(repo_url, show_col_types = FALSE)

      # Verify backup data loaded properly, the same dimension checking as above
      if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
        data_source_type <- "backup"
      } else {
        stop("Wrong dimensions in the GitHub backup clinical information data")
      }

    }, error = function(e) {
      clinical_data <<- NULL  # Ensure NULL for next fallback
    })
  }

  # Attempt 3: Check for local CSV file in data/ folder
  if (is.null(clinical_data)) {
    tryCatch({
      local_file_path <- here("data", "mmc1-ClinicalInformation.csv")

      if (file.exists(local_file_path)) {
        clinical_data <- read_csv(local_file_path, show_col_types = FALSE)

        # Verify local data loaded properly, same dimension checking
        if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
          data_source_type <- "local"
        } else {
          stop("Wrong dimensions in local clinical information data file")
        }
      } else {
        stop("Local clinical information data file not found")
      }

    }, error = function(e) {
      # If all three attempts fail, create empty dataset to prevent knitting errors
      clinical_data <<- data.frame()
      data_source_type <<- "all-failed"
    })
  }

}))

# Create unified inline text variables for both datasets
# Assume both datasets have same source availability (same host, same access restrictions)
if (data_source_type == "original") {
  unified_data_source_text <- "both datasets were loaded directly from ScienceDirect's supplementary materials: [S1 Table](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) (clinical data) and [S2 Table](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx) (gene expression data)."
} else if (data_source_type == "backup") {
  unified_data_source_text <- "the ScienceDirect links were unavailable, so both datasets were loaded from processed copies in [this coursework's repository](https://github.com/joelyu/HDS-W1): [clinical data](https://github.com/joelyu/HDS-W1/blob/main/data/mmc1-ClinicalInformation.csv) and [gene expression data](https://github.com/joelyu/HDS-W1/blob/main/data/mmc2-GeneExpression.csv)."
} else if (data_source_type == "local") {
  unified_data_source_text <- "both online sources were unavailable, so both datasets were loaded from local copies in the `data/` folder."
} else if (data_source_type == "all-failed"){
  unified_data_source_text <- "all data sources (ScienceDirect, GitHub repository, and local files) are unavailable. Please download both CSV files from [this coursework's repository](https://github.com/joelyu/HDS-W1/tree/main/data) and place them in the `data/` folder, then re-knit this document."
}

# Store row and column counts for MMC1 (Clinical data)
if (data_source_type == "all-failed") {
  # Hardcode expected values if all data sources fail
  n_patients_clinical <- 1001  # Number of patients in clinical dataset
  n_clinical_variables <- 35   # Number of clinical variables (including patient ID)
} else {
  n_patients_clinical <- ifelse(is.null(clinical_data), 0, nrow(clinical_data))
  n_clinical_variables <- ifelse(is.null(clinical_data), 0, ncol(clinical_data))
}

# Load MMC2 (Gene Expression) data with same fallback mechanism
suppressMessages(suppressWarnings({

  # Define data source URLs for MMC2
  direct_url_mmc2 <- "https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx"
  repo_url_mmc2 <- "https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc2-GeneExpression.csv"

  # Initialise variables for tracking MMC2 data source
  gene_expression_data <- NULL
  data_source_type_mmc2 <- ""

  # Attempt 1: Load from original ScienceDirect URL
  tryCatch({
    temp_file_mmc2 <- tempfile(fileext = ".xlsx")
    download.file(direct_url_mmc2, temp_file_mmc2, mode = "wb", quiet = TRUE)

    # Verify file downloaded and is readable
    if (file.exists(temp_file_mmc2) && file.size(temp_file_mmc2) > 0) {
      gene_expression_data <- read_excel(temp_file_mmc2, sheet = "Gene Expression", skip = 3)

      # Verify data loaded properly, i.e. matches known dimensions (775 rows × 21 columns)
      if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
        data_source_type_mmc2 <- "original"
      } else {
        stop("Wrong dimensions in the ScienceDirect Gene Expression dataset")
      }
    } else {
      stop("Gene expression data from Table S2 failed to download")
    }

  }, error = function(e) {
    gene_expression_data <<- NULL  # Ensure NULL for fallback
  })

  # Attempt 2: Fallback to processed backup dataset
  if (is.null(gene_expression_data)) {
    tryCatch({
      gene_expression_data <- read_csv(repo_url_mmc2, show_col_types = FALSE)

      # Verify backup data loaded properly, same dimension checking
      if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
        data_source_type_mmc2 <- "backup"
      } else {
        stop("Wrong dimensions in the GitHub backup gene expression data")
      }

    }, error = function(e) {
      gene_expression_data <<- NULL  # Ensure NULL for next fallback
    })
  }

  # Attempt 3: Check for local CSV file in data/ folder
  if (is.null(gene_expression_data)) {
    tryCatch({
      local_file_path_mmc2 <- here("data", "mmc2-GeneExpression.csv")

      if (file.exists(local_file_path_mmc2)) {
        gene_expression_data <- read_csv(local_file_path_mmc2, show_col_types = FALSE)

        # Verify local data loaded properly, same dimension checking
        if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
          data_source_type_mmc2 <- "local"
        } else {
          stop("Wrong dimensions in local gene expression data file")
        }
      } else {
        stop("Local gene expression data file not found")
      }

    }, error = function(e) {
      # If all three attempts fail, create empty dataset to prevent knitting errors
      gene_expression_data <<- data.frame()
      data_source_type_mmc2 <<- "all-failed"
    })
  }

}))

# Note: Using unified data source text based on MMC1 status
# Both datasets from same host, so assume same availability

# Store row and column counts for MMC2 (Gene Expression data)
if (data_source_type_mmc2 == "all-failed") {
  # Hardcode expected values if all data sources fail
  n_patients_expression <- 775    # Number of patients with gene expression data
  n_total_columns <- 21           # Total columns: 1 patient ID + 1 RNA check + 19 genes
  n_genes_measured <- 19          # Number of genes with expression measurements
} else {
  n_patients_expression <- ifelse(is.null(gene_expression_data), 0, nrow(gene_expression_data))
  n_total_columns <- ifelse(is.null(gene_expression_data), 0, ncol(gene_expression_data))
  n_genes_measured <- ifelse(is.null(gene_expression_data), 0, ncol(gene_expression_data) - 2)  # Subtract patient ID and RNA check columns
}
```

```{r data-integration, cache = TRUE}
# Combine MMC1 and MMC2 datasets via patient ID matching

# Select key variables from clinical dataset (MMC1)
clinical_selected <- clinical_data %>%
  select(
    sample_id = `Sample  ID`,
    gender = Gender,
    response_therapy = `Response to initial therapy`,
    age_at_diagnosis = `age at diagnosis`,
    MYC = `log2 MYC expr`,
    BCL2 = `log2 BCL2 expr`,
    log2_bcl6_mmc1 = `log2 BCL6 expr`
  )

# Select gene expression data from MMC2 (exclude Samples and metadata columns)
expression_selected <- gene_expression_data %>%
  select(-Samples, -`RNA-seq core set of samples`) %>%
  rename(log2_bcl6_mmc2 = BCL6) %>%  # Rename for validation
  bind_cols(sample_id = gene_expression_data$Samples, .)

# Inner join to keep only patients with both clinical and expression data
combined_data <- clinical_selected %>%
  inner_join(expression_selected, by = "sample_id") %>%
  mutate(
    # Create binary therapy response variable
    complete_response = case_when(
      response_therapy == "Complete response" ~ "Complete response",
      response_therapy %in% c("Partial response", "No response") ~ "Incomplete response",
      TRUE ~ NA_character_
    ),
    complete_response = factor(complete_response,
                              levels = c("Complete response", "Incomplete response")),
    # Create age groups based on NCCN-IPI classification
    age_group_nccn = case_when(
      age_at_diagnosis <= 40 ~ "≤40 years",
      age_at_diagnosis <= 60 ~ "41-60 years",
      age_at_diagnosis <= 75 ~ "61-75 years",
      age_at_diagnosis > 75 ~ ">75 years",
      TRUE ~ NA_character_
    ),
    age_group_nccn = factor(age_group_nccn,
                           levels = c("≤40 years", "41-60 years", "61-75 years", ">75 years"))
  ) %>%
  # Reorder columns for logical flow
  relocate(complete_response, .after = response_therapy)

# Validate BCL6 consistency and keep one version
bcl6_validation <- combined_data %>%
  filter(!is.na(log2_bcl6_mmc1), !is.na(log2_bcl6_mmc2)) %>%
  mutate(bcl6_difference = abs(log2_bcl6_mmc1 - log2_bcl6_mmc2))

# Remove duplicate BCL6 column and rename
combined_data <- combined_data %>%
  select(-log2_bcl6_mmc2) %>%
  rename(BCL6 = log2_bcl6_mmc1)

# Store dimensions for inline text
n_final_patients <- nrow(combined_data)
n_final_variables <- ncol(combined_data)
```

Diffuse large B cell lymphoma (DLBCL) is the most common type of aggressive non-Hodgkin's lymphoma (NHL) [@blood1997; @WANG2023], with a wide range of factors contributing to prognosis. For a comparable and comprehensive pre-treatment prognosis model, the international prognostic index (IPI) emerged as a standardised model for DLBCL and other aggressive NHLs [@shipp1993], combining 5 factors: age, Ann Arbor stage classification, ECOG Performance Status, serum lactate dehydrogenase (LDH) level and the number of extranodal sites of disease. By pooling factors together, the IPI outperformed simple disease stage classification models such as Ann Arbor. [@zhou2014NCCN-IPI] went on to improve on the IPI, creating the National Comprehensive Cancer Network International Prognostic Index (NCCN-IPI) as an update to the IPI. A key innovation of the NCCN-IPI was using cubic splines to model the continuous factors of age and LDH levels as higher resolution categorical factors, modifying them from binary factors to quaternary and ternary factors respectively. As prognosis models improved, so did treatment. The first generation chemotherapy of cyclophosphamide, doxorubicin, vincristine, and prednisone (CHOP) had a cure rate of 30-35% [@Fisher1993CHOP]. With the addition of rituximab to the regimen (R-CHOP) and other advances, DLBCL becomes curable for more than 60% of patients [@johnson2012doublehit]. 

While age is incorporated into the IPI (and subsequent NCCN-IPI), other demographic factors such as gender are not, despite established evidence for their prognostic involvement. Males demonstrate higher hazard ratios [@Carella2013male] and gender-associated pharmacokinetic differences in rituximab lead to worse treatment responses in males [@Habermann2014sexAge]. These demographic effects raise questions about whether risk factors perform uniformly across patient subgroups. Beyond demographic and clinical factors, a series of genetic alterations have emerged as strong prognostic markers: BCL2 [@Gascoyne1997BCL2], BCL6 [@LoCoco1994BCL6] and MYC [@ChenevixTrench1986MYC]. These changes are observed at both the genotypic and phenotypic levels, as translocation mutations and protein overexpression respectively [@Petrich2014MYCReview]. Furthermore, patients with varying combinations of these alterations have shown worse responses to R-CHOP treatments, highlighting the clinical relevance of genomic profiling. Some genetic markers have shown age-associated expression patterns, and certain genetic drivers (BCL6, IRF4) lose prognostic significance when age is incorporated in multivariate models [@Klapper2012ageInteraction]. This indicates that demographic factors may not merely add to genomic risk additively, but could modify how these genomic drivers influence clinical outcomes.

With the advent of machine learning methods came attempts to construct models based on clinical and genomic data. @reddy2017paper performed whole exome and transcriptome sequencing in 1001 DLBCL patients, identifying 150 genetic drivers including BCL2, BCL6, and MYC alongside numerous newly characterised candidates. By combining genotypic alterations, gene expression data and cell-of-origin classification, they developed a genomic risk model that outperformed the IPI. However, the potential for demographic factors to modify these genomic associations remains understudied. Given that age and gender both demonstrate prognostic significance and influence treatment response, it remains unknown whether genomic risk markers perform uniformly across demographic subgroups. If these demographic factors modify how gene expression levels impact treatment response, such that the same gene expression levels in different gender or age groups lead to different prognostic outcomes, it would be crucial that these differences are identified and applied in future models to prevent inaccurate prognoses. 

This study addresses this gap by investigating whether age and gender interact and modify the prognostic associations between gene expression markers and therapy response in DLBCL. The associations between the demographic factors (age & gender) with complete therapy response and the gene expression levels of 21 genes were first considered. Logistic regression models using gene expression levels of 21 genes were fitted with therapy response, and the interaction of demographic factors with these gene expression levels were examined. Exploring how demographic factors interact with known and potential genomic drivers of DLBCL could reveal age or gender-dependent tumour biology that inform therapeutic approaches.

The analysis utilises clinical and gene expression data[@reddy2017dataset] from Reddy et al.'s genomic risk model study[@reddy2017paper] of `r n_patients_clinical` DLBCL patients, focusing on `r n_patients_expression` patients with complete gene expression profiles for `r n_genes_measured + 2` genes including the big three oncogenic drivers (MYC, BCL2, BCL6) and cell-of-origin classifiers. Detailed data breakdown and processing are documented in the [Methods](#methods) section.

# Methods {#methods}

## Data Availability & Access

The datasets were publicly available on the ScienceDirect [webpage](https://www.sciencedirect.com/science/article/pii/S0092867417311212) of  Reddy et. al's study[@reddy2017paper], and the corresponding author was contacted via email to inform them of this secondary analysis. A public [GitHub repository](https://github.com/joelyu/HDS-W1) was created to host the processed datasets, attribution, license information and supplementary materials to ensure data openness, transparency and reproducibility. For the original study, the authors obtained anonymised patient clinical information and tumours, which were processed in line with a protocol approved by the Institutional Review Board at Duke University. Thus no further anonymisation is required. A total number of 2 datasets were downloaded as Excel files directly from their links on the aforementioned ScienceDirect, [Table S1](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) and [Table S2](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx) using the `download.file` function from R's `utils` package [@R-base] and read via the `readxl` package [@readxl]. The specific sheets were selected then cleaned to be exported as `.csv` files (see [`01-data-preprocessing.R`](https://github.com/joelyu/HDS-W1/blob/4374f49386fbd61b173d46e15218e792497948c2/supplementary-materials/01-data-preprocessing.R)[@tidyverse, @here]). The processed `.csv` files were uploaded to this project's GitHub repository: [`mmc1-ClinicalInformation.csv` (raw)](https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc1-ClinicalInformation.csv), [`mmc2-GeneExpression.csv` (raw)](https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc2-GeneExpression.csv). This RMarkdown document is self-sufficient and contains code for the relevant analysis and plots shown only, for a complete analysis including assumption testing, post-hoc analysis, tests that showed insignificant results, please refer to the sequenced scripts in [`supplementary-materials`](https://github.com/joelyu/HDS-W1/tree/4374f49386fbd61b173d46e15218e792497948c2/supplementary-materials) folder of this repository. This document also supports sourcing the datasets from 3 sources for redundancy: original ScienceDirect links, processed `.csv` files on GitHub and local processed `.csv` files when this repository is downloaded. For this knitted[@knitr] HTML document, `r unified_data_source_text` 

## Data Cleaning & Selection

The 2 datasets were joined using common patient IDs and 2 new columns were added. `age_group_nccn` was obtained by transforming the age at diagnosis variable into 4 categorical groups according to cutoffs defined by NCCN-IPI[@zhou2014NCCN-IPI]: $≤40, 41 - 60, 61 - 75, >75$. `complete_response` was added by combining "Partial response" and "No response" as "Incomplete response" from `response_therapy` while keeping "Complete response" unchanged. This prepared the dataset for hierarchical binomial logistic regression. As for duplicate gene expression columns for BCL6, the two columns were compared to verify identicality and 1 was discarded. The resulting table was one with `r n_final_patients` patients and `r n_final_variables` variables, of which include the anonymised patient ID; demographic variables such as gender (binary: F/M), age (continuous, at diagnosis) and age group (quaternary, as defined by NCCN-IPI); clinical information of therapy response (ternary: Complete response, Partial response, No response); and the log2 transformed gene expression levels of 21 genes: MYC, BCL2, BCL6, ITPKB, MME, MYBL1, DENND3, NEK6, LMO2, LRMP, SH3BP5, IRF4, PIM1, ENTPD1, BLNK, CCND2, ETV6, FUT8, BMF, IL16 and PTPN1. 

Gene expression data were limited to these 21 genes available from the original study's datasets ([S1](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) & [S2](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx)), representing 2 categories. The first category is the "big three" oncogenic drivers of MYC, BCL2 and BCL6, serving as strong prognostic markers. Moreover, MYC [@Kurz2025ageSexGeneRef-Rel] and BCL6 [@Klapper2012ageInteraction] have both shown age-dependent prognostic effects, suggesting age may modify how these markers influence clinical outcomes. The second category comprises 19 cell-of-origin classifier genes (DLBCL subtypes: ABC vs GCB) [@wright2003cellOfOriginGeneExpression], with BCL6 appearing in both categories. Despite their initial utility for classification, genes such as CCND2 and LMO2 [@Lossos2004LMO2CCND2] have shown to be strong survival predictors alongside BCL2 and BCL6. More importantly, IRF4 is among the genetic features showing age associations and contributes to genetic complexity that loses prognostic significance when age is incorporated [@Klapper2012ageInteraction], alongside BCL6. Both categories therefore contain genes with potential to interact with demographic factors, making them suitable for testing whether demographic factors modify their prognostic associations.

Overall, data completeness for these `r n_final_variables` columns was exceptional, with 23 columns being 100%, and the remaining 4 columns all with more than 93% completeness. Processing is documented in [`02-data-processing.R`](https://github.com/joelyu/HDS-W1/blob/4374f49386fbd61b173d46e15218e792497948c2/supplementary-materials/02-data-processing.R). Characteristics of the cohort are summarised[@kableExtra] in [Table 1](#table1).

<div id="table1">
**Table 1. Baseline Cohort Characteristics**
</div>

```{r cohort-characteristics, echo=FALSE, results='markup'}
# Create cohort characteristics table stratified by complete response

# Calculate overall statistics
total_n <- nrow(combined_data)

# Get response group sample sizes
response_groups <- c("Complete response", "Incomplete response")
response_n <- combined_data %>%
  filter(!is.na(complete_response)) %>%
  count(complete_response) %>%
  arrange(match(complete_response, response_groups))

# Gender distributions by response group
gender_response_table <- combined_data %>%
  filter(!is.na(complete_response), !is.na(gender)) %>%
  count(complete_response, gender) %>%
  group_by(complete_response) %>%
  mutate(
    response_total = sum(n),
    pct = round(100 * n / response_total, 1)
  ) %>%
  ungroup() %>%
  select(complete_response, gender, n, pct) %>%
  pivot_wider(
    names_from = complete_response,
    values_from = c(n, pct),
    names_sep = "_",
    values_fill = 0
  ) %>%
  arrange(match(gender, c("F", "M")))

# Age statistics by response group
age_response_stats <- combined_data %>%
  filter(!is.na(age_at_diagnosis), !is.na(complete_response)) %>%
  group_by(complete_response) %>%
  summarise(
    mean_age = mean(age_at_diagnosis, na.rm = TRUE),
    sd_age = sd(age_at_diagnosis, na.rm = TRUE),
    .groups = 'drop'
  )

total_age_mean <- mean(combined_data$age_at_diagnosis, na.rm = TRUE)
total_age_sd <- sd(combined_data$age_at_diagnosis, na.rm = TRUE)

# Age group distributions by response group
age_group_response_stats <- combined_data %>%
  filter(!is.na(complete_response), !is.na(age_group_nccn)) %>%
  group_by(complete_response, age_group_nccn) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(complete_response) %>%
  mutate(
    total = sum(n),
    pct = round(100 * n / total, 1)
  ) %>%
  ungroup()

# Helper function to get values safely
get_value <- function(data, col_pattern) {
  cols <- grep(col_pattern, names(data), value = TRUE)
  if (length(cols) > 0) {
    return(data[[cols[1]]])
  }
  return(0)
}

# Build the table data
cohort_table <- data.frame(
  Characteristic = c(
    "**Sample size**",
    "**Gender**",
    "  Female",
    "  Male",
    "**Age at diagnosis, years**",
    "**Age groups (NCCN-IPI)**",
    "  ≤40 years",
    "  41-60 years",
    "  61-75 years",
    "  >75 years"
  ),
  Total = c(
    paste0("N = ", total_n),
    "",
    paste0(sum(combined_data$gender == "F", na.rm = TRUE), " (",
           round(100 * sum(combined_data$gender == "F", na.rm = TRUE) / total_n, 1), "%)"),
    paste0(sum(combined_data$gender == "M", na.rm = TRUE), " (",
           round(100 * sum(combined_data$gender == "M", na.rm = TRUE) / total_n, 1), "%)"),
    paste0(round(total_age_mean, 1), " ± ", round(total_age_sd, 1)),
    "",
    paste0(sum(combined_data$age_group_nccn == "≤40 years", na.rm = TRUE), " (",
           round(100 * sum(combined_data$age_group_nccn == "≤40 years", na.rm = TRUE) /
                 sum(!is.na(combined_data$age_group_nccn)), 1), "%)"),
    paste0(sum(combined_data$age_group_nccn == "41-60 years", na.rm = TRUE), " (",
           round(100 * sum(combined_data$age_group_nccn == "41-60 years", na.rm = TRUE) /
                 sum(!is.na(combined_data$age_group_nccn)), 1), "%)"),
    paste0(sum(combined_data$age_group_nccn == "61-75 years", na.rm = TRUE), " (",
           round(100 * sum(combined_data$age_group_nccn == "61-75 years", na.rm = TRUE) /
                 sum(!is.na(combined_data$age_group_nccn)), 1), "%)"),
    paste0(sum(combined_data$age_group_nccn == ">75 years", na.rm = TRUE), " (",
           round(100 * sum(combined_data$age_group_nccn == ">75 years", na.rm = TRUE) /
                 sum(!is.na(combined_data$age_group_nccn)), 1), "%)")
  ),
  Complete_Response = c(
    paste0("n = ", response_n$n[response_n$complete_response == "Complete response"]),
    "",
    paste0(get_value(gender_response_table[gender_response_table$gender == "F", ], "n_Complete response"), " (",
           get_value(gender_response_table[gender_response_table$gender == "F", ], "pct_Complete response"), "%)"),
    paste0(get_value(gender_response_table[gender_response_table$gender == "M", ], "n_Complete response"), " (",
           get_value(gender_response_table[gender_response_table$gender == "M", ], "pct_Complete response"), "%)"),
    paste0(round(age_response_stats$mean_age[age_response_stats$complete_response == "Complete response"], 1), " ± ",
           round(age_response_stats$sd_age[age_response_stats$complete_response == "Complete response"], 1)),
    "",
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Complete response" &
                                     age_group_response_stats$age_group_nccn == "≤40 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Complete response" &
                                       age_group_response_stats$age_group_nccn == "≤40 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Complete response" &
                                     age_group_response_stats$age_group_nccn == "41-60 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Complete response" &
                                       age_group_response_stats$age_group_nccn == "41-60 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Complete response" &
                                     age_group_response_stats$age_group_nccn == "61-75 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Complete response" &
                                       age_group_response_stats$age_group_nccn == "61-75 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Complete response" &
                                     age_group_response_stats$age_group_nccn == ">75 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Complete response" &
                                       age_group_response_stats$age_group_nccn == ">75 years"], "%)")
  ),
  Incomplete_Response = c(
    paste0("n = ", response_n$n[response_n$complete_response == "Incomplete response"]),
    "",
    paste0(get_value(gender_response_table[gender_response_table$gender == "F", ], "n_Incomplete response"), " (",
           get_value(gender_response_table[gender_response_table$gender == "F", ], "pct_Incomplete response"), "%)"),
    paste0(get_value(gender_response_table[gender_response_table$gender == "M", ], "n_Incomplete response"), " (",
           get_value(gender_response_table[gender_response_table$gender == "M", ], "pct_Incomplete response"), "%)"),
    paste0(round(age_response_stats$mean_age[age_response_stats$complete_response == "Incomplete response"], 1), " ± ",
           round(age_response_stats$sd_age[age_response_stats$complete_response == "Incomplete response"], 1)),
    "",
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Incomplete response" &
                                     age_group_response_stats$age_group_nccn == "≤40 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Incomplete response" &
                                       age_group_response_stats$age_group_nccn == "≤40 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Incomplete response" &
                                     age_group_response_stats$age_group_nccn == "41-60 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Incomplete response" &
                                       age_group_response_stats$age_group_nccn == "41-60 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Incomplete response" &
                                     age_group_response_stats$age_group_nccn == "61-75 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Incomplete response" &
                                       age_group_response_stats$age_group_nccn == "61-75 years"], "%)"),
    paste0(age_group_response_stats$n[age_group_response_stats$complete_response == "Incomplete response" &
                                     age_group_response_stats$age_group_nccn == ">75 years"], " (",
           age_group_response_stats$pct[age_group_response_stats$complete_response == "Incomplete response" &
                                       age_group_response_stats$age_group_nccn == ">75 years"], "%)")
  )
)

# Create the formatted table
cohort_table %>%
  kable(
    col.names = c("Characteristic", "Total (N=775)", "Complete Response", "Incomplete Response"),
    align = c("l", "c", "c", "c"),
    escape = FALSE
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  ) %>%
  column_spec(1, bold = FALSE, width = "2.5in") %>%
  column_spec(2:4, width = "1.5in") %>%
  row_spec(c(1, 2, 5, 6), bold = TRUE) %>%
  add_footnote(
    # c("Values shown as n (%) for categorical variables and mean ± SD for continuous variables",
    #   "NCCN-IPI age groups: National Comprehensive Cancer Network International Prognostic Index",
    #   "Complete response vs Incomplete response (Partial + No response combined)",
    #   "Percentages calculated within each age group for gender distributions and treatment responses"),
    notation = "none"
  )
```

<div class="figure-caption">
Demographic and clinical characteristics stratified by treatment response. <br> Values shown as n (%) for categorical variables and mean ± SD for continuous variables. <br> Treatment response categories combine partial and no response as "Incomplete response" versus complete response. <br> NCCN-IPI age groups represent National Comprehensive Cancer Network International Prognostic Index classifications. <br> Percentages are calculated within each response group for gender and age group distributions.
</div>

## Exploratory Statistics {#exploratory-stats}

Baseline gene expression patterns across demographic groups were examined using t-test (gender) and one-way Welch's ANOVA[@rstatix] (age groups) with false discovery rate (FDR)[@Reiner2003FDRGeneExpression] correction due to the number of genes analysed (see [`04-data-analysis.R`](https://github.com/joelyu/HDS-W1/blob/77db28d5411251b14940ad21b18b7e69bfa0f3b2/supplementary-materials/04-data-analysis.R)). Post-hoc Games-Howell tests were conducted for significant ANOVA results[@CoreStats]. Assumptions for these tests were checked with diagnostic tests and plots, and the overall distribution of gene expression against age and gender visually examined (see [`03-data-exploration.R`](https://github.com/joelyu/HDS-W1/blob/77db28d5411251b14940ad21b18b7e69bfa0f3b2/supplementary-materials/03-data-exploration.R)). Second, associations between therapy response completeness and demographic factors were examined with the Chi-squared tests, with expected frequencies checked to be $> 5$ (see [`05-response-analysis.R`](https://github.com/joelyu/HDS-W1/blob/main/supplementary-materials/05-response-analysis.R)).

## Interaction Effects

The baseline information from [Exploratory Statistics](#exploratory-stats) only describes demographic-associated patterns, but not whether demographic factors modify the prognostic associations of gene expression. To systematically isolate and analyse these prognostic associations of gene expression, demographic factors and the interaction between the two, hierarchical logistic regression models[@broom] were fitted for all 21 genes and 2 demographic factors (42 combinations). Each combination had four logistic regression models fitted to identify significant terms that contribute to therapy response completeness, the models were nested as:

1. Null model: therapy response ~ 1
2. Gene-only model: therapy response ~ gene expression
3. Main effect model: therapy response ~ gene expression + demographic factors (age or gender)
4. Interaction model: therapy response ~ gene expression + demographic factors (age or gender) + gene-demographic interactions

All fitted models were analysed with likelihood-ratio test (LRT) to obtain FDR-corrected p-values. Significant models were then checked for model fit with goodness-of-fit with Chi-square tests and Akaike Information Criterion (AIC) scores, along with influential observations and collinearity [@GLMCambio] (see [`06-effect-analysis.R`](https://github.com/joelyu/HDS-W1/blob/main/supplementary-materials/06-effect-analysis.R).)

```{r analysis-ANOVA, cache = TRUE}
# Perform ANOVA analysis for gene expression by demographic groups

# Get gene expression variables (excluding clinical variables)
gene_expression_vars <- combined_data %>%
  select(-sample_id, -gender, -response_therapy, -complete_response,
         -age_at_diagnosis, -age_group_nccn) %>%
  names()

# Initialize ANOVA results storage
age_anova_summary <- list()

# Perform Welch ANOVA for each gene
for (gene in gene_expression_vars) {
  # Prepare data for ANOVA
  analysis_data <- combined_data %>%
    filter(!is.na(.data[[gene]]), !is.na(age_group_nccn)) %>%
    select(all_of(gene), age_group_nccn)

  if (nrow(analysis_data) >= 20) {
    # Perform Welch ANOVA (handles unequal variances)
    anova_result <- oneway.test(
      analysis_data[[gene]] ~ analysis_data$age_group_nccn,
      var.equal = FALSE
    )

    # Calculate eta-squared (effect size)
    grand_mean <- mean(analysis_data[[gene]], na.rm = TRUE)
    group_stats <- analysis_data %>%
      group_by(age_group_nccn) %>%
      summarise(n = n(), mean = mean(.data[[gene]], na.rm = TRUE), .groups = "drop")

    ss_between <- sum(group_stats$n * (group_stats$mean - grand_mean)^2)
    ss_total <- sum((analysis_data[[gene]] - grand_mean)^2, na.rm = TRUE)
    eta_squared <- ss_between / ss_total

    # Store summary results
    age_anova_summary[[gene]] <- data.frame(
      gene = gene,
      n_total = nrow(analysis_data),
      f_statistic = round(anova_result$statistic, 3),
      df_num = anova_result$parameter[1],
      df_den = round(anova_result$parameter[2], 1),
      p_value = anova_result$p.value,
      eta_squared = round(eta_squared, 3),
      stringsAsFactors = FALSE
    )
  }
}

# Combine ANOVA summaries and adjust p-values
age_anova_table <- bind_rows(age_anova_summary) %>%
  mutate(p_adjusted = p.adjust(p_value, method = "fdr")) %>%
  mutate(significant_adjusted = p_adjusted < 0.05) %>%
  arrange(p_value)

# Identify genes with significant ANOVA results for Games-Howell
significant_anova_genes <- age_anova_table %>%
  filter(significant_adjusted == TRUE) %>%
  pull(gene)

# Games-Howell post-hoc analysis for significant genes
games_howell_summary <- list()

if (length(significant_anova_genes) > 0) {
  for (gene in significant_anova_genes) {
    # Prepare data
    analysis_data <- combined_data %>%
      filter(!is.na(.data[[gene]]), !is.na(age_group_nccn)) %>%
      select(all_of(gene), age_group_nccn)

    # Games-Howell test
    games_howell_result <- analysis_data %>%
      games_howell_test(formula(paste(gene, "~ age_group_nccn")))

    # Convert to consistent format
    games_howell_tidy <- games_howell_result %>%
      select(group1, group2, estimate = estimate, p.adj, p.adj.signif)

    # Create summary table
    games_howell_summary[[gene]] <- games_howell_tidy %>%
      mutate(
        gene = gene,
        comparison = paste(group1, "vs", group2),
        mean_difference = round(estimate, 3),
        p_value = p.adj,
        significant = p.adj < 0.05,
        .before = 1
      ) %>%
      select(gene, comparison, mean_difference, p_value, significant)
  }
}

# Combine Games-Howell summaries
if (length(games_howell_summary) > 0) {
  games_howell_table <- bind_rows(games_howell_summary) %>%
    arrange(gene, p_value)
} else {
  games_howell_table <- data.frame()
}
```

```{r logistic-regression-analysis, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=TRUE}
# Perform logistic regression analysis with demographic interactions

# Prepare data for logistic regression
analysis_data <- combined_data %>%
  filter(!is.na(complete_response)) %>%
  mutate(response_binary = ifelse(complete_response == "Complete response", 1, 0))

# Identify gene expression variables (excluding clinical variables)
non_gene_cols <- c(
  "sample_id", "gender", "response_therapy", "complete_response",
  "age_at_diagnosis", "os_years", "censored", "age_group_nccn", "response_binary"
)
gene_expression_vars <- setdiff(names(analysis_data), non_gene_cols)

# Function to fit interaction models for each gene
fit_interaction_models <- function(data, genes, interaction_var, interaction_name, silent = TRUE) {
  results <- list()

  for (gene in genes) {
    tryCatch({
      # Filter data for this gene (matching script approach)
      gene_data <- data %>%
        filter(!is.na(.data[[gene]]), !is.na(.data[[interaction_var]]))

      if (nrow(gene_data) < 10) next

      # Fit nested models (using reformulate like in script)
      null_model <- glm(response_binary ~ 1,
                       data = gene_data, family = binomial)

      gene_model <- glm(reformulate(gene, "response_binary"),
                       data = gene_data, family = binomial)

      main_model <- glm(reformulate(c(gene, interaction_var), "response_binary"),
                               data = gene_data, family = binomial)

      interaction_model <- glm(reformulate(c(gene, interaction_var,
                                           paste(gene, interaction_var, sep = ":")),
                                         "response_binary"),
                              data = gene_data, family = binomial)

      # Likelihood ratio tests - all models now use identical datasets
      lrt_gene_vs_null <- anova(null_model, gene_model, test = "Chisq")
      lrt_main_vs_gene <- anova(gene_model, main_model, test = "Chisq")
      lrt_interaction_vs_main <- anova(main_model, interaction_model, test = "Chisq")

      # Extract p-values
      gene_p <- lrt_gene_vs_null$`Pr(>Chi)`[2]
      demographic_p <- lrt_main_vs_gene$`Pr(>Chi)`[2]
      interaction_p <- lrt_interaction_vs_main$`Pr(>Chi)`[2]

      # Store results (matching script structure)
      results[[gene]] <- list(
        null_model = null_model,
        gene_model = gene_model,
        main_effects_model = main_model,
        interaction_model = interaction_model,
        gene_p = gene_p,
        demographic_p = demographic_p,
        interaction_p = interaction_p,
        n_patients = nrow(gene_data)
      )

    }, error = function(e) {
      if (!silent) {
        cat("Error with gene", gene, ":", e$message, "\n")
      }
      cat("ERROR with gene", gene, ":", e$message, "\n")
    })
  }

  return(results)
}

# Run age group interaction analysis
age_interaction_results <- fit_interaction_models(
  analysis_data, gene_expression_vars, "age_group_nccn", "Age", silent = TRUE
)

# Extract p-values and apply FDR correction
age_interaction_p_values <- sapply(age_interaction_results, function(x) x$interaction_p)
age_interaction_p_values <- age_interaction_p_values[!is.na(age_interaction_p_values)]

# FDR correction
age_fdr_adj <- p.adjust(age_interaction_p_values, method = "fdr")
sig_age_genes <- names(age_fdr_adj)[age_fdr_adj < 0.05]

# Create comprehensive results table
gene_names <- names(age_interaction_p_values)
age_lrt_comprehensive <- data.frame(
  gene = gene_names,
  interaction_p = as.numeric(age_interaction_p_values),
  interaction_p_adj = as.numeric(age_fdr_adj),
  significant_interaction = age_fdr_adj < 0.05,
  stringsAsFactors = FALSE
)

# Sort the results table
age_lrt_comprehensive <- age_lrt_comprehensive %>%
  arrange(interaction_p_adj, interaction_p)

# Extract gene-only effects for all genes (for forest plot)
all_gene_effects <- map_dfr(age_interaction_results, function(result) {
  if (!is.null(result$gene_model)) {
    tryCatch({
      tidy_model <- tidy(result$gene_model, conf.int = TRUE)
      if (nrow(tidy_model) >= 2) {
        gene_row <- tidy_model[2, ]  # Second row is the gene coefficient
        return(gene_row)
      }
    }, error = function(e) {
      return(NULL)
    })
  }
  return(NULL)
}, .id = "gene")

# Filter and process only if we have results
if (nrow(all_gene_effects) > 0 && "estimate" %in% names(all_gene_effects)) {
  all_gene_effects <- all_gene_effects %>%
    filter(!is.na(estimate)) %>%
    mutate(
      odds_ratio = exp(estimate),
      or_lower = exp(conf.low),
      or_upper = exp(conf.high),
      p_adj = p.adjust(p.value, method = "fdr")
    )
} else {
  # Create empty data frame with required columns
  all_gene_effects <- data.frame(
    gene = character(0),
    term = character(0),
    estimate = numeric(0),
    std.error = numeric(0),
    statistic = numeric(0),
    p.value = numeric(0),
    conf.low = numeric(0),
    conf.high = numeric(0),
    odds_ratio = numeric(0),
    or_lower = numeric(0),
    or_upper = numeric(0),
    p_adj = numeric(0),
    stringsAsFactors = FALSE
  )
}

# Store specific models for visualization
if ("MYC" %in% names(age_interaction_results)) {
  myc_gene_model <- age_interaction_results[["MYC"]]$gene_model
  myc_interaction_model <- age_interaction_results[["MYC"]]$interaction_model
}

if ("CCND2" %in% names(age_interaction_results)) {
  ccnd2_gene_model <- age_interaction_results[["CCND2"]]$gene_model
  ccnd2_interaction_model <- age_interaction_results[["CCND2"]]$interaction_model
}

# Summary statistics for reporting
n_genes_analyzed <- length(age_interaction_results)
n_significant_interactions <- sum(age_lrt_comprehensive$significant_interaction)
```

# Results

## Exploratory Associations

### Baseline Gene Expression Patterns by Demographics

Gene expression levels showed no significant differences across gender groups after t-test with FDR correction. Ten genes showed significantly different expression levels after Welch's ANOVA with FDR correction across NCCN-IPI age groups: BCL2 (p = 0.0002), BLNK (p = 0.003), MYBL1 (p = 0.010), SH3BP5 (p = 0.016), ITPKB (p = 0.020), CCND2 (p = 0.020), PTPN1 (p = 0.031), BMF (p = 0.034), FUT8 (p = 0.037), LMO2 (p = 0.038). Post-hoc analysis with Games-Howell revealed that age groups mostly clustered into two statistically distinct groups for each gene, save for BLNK with three groups [Figure 1](#figure1)[@plotly, @multcompView, @RColorBrewer]. 

<div id="figure1">
**Figure 1. Gene Expression Patterns Across Age Groups.**
</div>

```{r gene-expression-barplot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=60, out.height="1800px", results='markup'}
# Get significant genes from ANOVA results
significant_genes <- age_anova_table %>%
  filter(significant_adjusted == TRUE) %>%
  pull(gene)

if (length(significant_genes) > 0) {

  # Function to create CLD letters for a given gene
  create_cld_letters <- function(gene_name) {
    gene_comparisons <- games_howell_table %>%
      filter(gene == gene_name)

    age_groups <- levels(combined_data$age_group_nccn)
    n_groups <- length(age_groups)

    if (nrow(gene_comparisons) > 0) {
      comparison_matrix <- matrix(1, nrow = n_groups, ncol = n_groups)
      rownames(comparison_matrix) <- colnames(comparison_matrix) <- age_groups
      diag(comparison_matrix) <- 0

      for (i in 1:nrow(gene_comparisons)) {
        groups <- str_split(gene_comparisons$comparison[i], " vs ")[[1]]
        group1 <- str_trim(groups[1])
        group2 <- str_trim(groups[2])

        if (group1 %in% age_groups && group2 %in% age_groups) {
          comparison_matrix[group1, group2] <- gene_comparisons$p_value[i]
          comparison_matrix[group2, group1] <- gene_comparisons$p_value[i]
        }
      }

      cld_letters <- multcompLetters(comparison_matrix, threshold = 0.05)$Letters
    } else {
      cld_letters <- rep("a", length(age_groups))
      names(cld_letters) <- age_groups
    }

    return(cld_letters)
  }

  # Reshape data for faceting - only significant genes
  faceted_data <- combined_data %>%
    select(sample_id, age_group_nccn, all_of(significant_genes)) %>%
    filter(!is.na(age_group_nccn)) %>%
    pivot_longer(
      cols = all_of(significant_genes),
      names_to = "gene",
      values_to = "expression"
    ) %>%
    filter(!is.na(expression))

  # Create CLD letters and summary stats for all significant genes
  gene_annotations <- map_dfr(significant_genes, function(gene) {
    gene_data <- faceted_data %>% filter(gene == !!gene)
    cld_letters <- create_cld_letters(gene)

    # Calculate summary stats for positioning
    gene_summary <- gene_data %>%
      group_by(age_group_nccn) %>%
      summarise(
        max_val = max(expression, na.rm = TRUE),
        min_val = min(expression, na.rm = TRUE),
        n = n(),
        .groups = "drop"
      ) %>%
      mutate(
        gene = gene,
        cld_letter = cld_letters[as.character(age_group_nccn)],
        # Position CLD letters above the max value
        label_y = max_val + 0.12 * (max(gene_data$expression, na.rm = TRUE) -
                                   min(gene_data$expression, na.rm = TRUE)),
        # Position sample sizes below the min value
        sample_label_y = min_val - 0.08 * (max(gene_data$expression, na.rm = TRUE) -
                                          min(gene_data$expression, na.rm = TRUE))
      )

    return(gene_summary)
  })

  # Calculate boxplot statistics manually to avoid plotly outlier issues
  box_stats <- faceted_data %>%
    group_by(gene, age_group_nccn) %>%
    summarise(
      q1 = quantile(expression, 0.25, na.rm = TRUE),
      median = quantile(expression, 0.5, na.rm = TRUE),
      q3 = quantile(expression, 0.75, na.rm = TRUE),
      iqr = q3 - q1,
      lower_whisker = max(min(expression, na.rm = TRUE), q1 - 1.5 * iqr),
      upper_whisker = min(max(expression, na.rm = TRUE), q3 + 1.5 * iqr),
      .groups = "drop"
    )

  # Calculate outliers manually
  faceted_data_with_outliers <- faceted_data %>%
    left_join(box_stats, by = c("gene", "age_group_nccn")) %>%
    mutate(
      is_outlier = expression < (q1 - 1.5 * iqr) | expression > (q3 + 1.5 * iqr)
    )

  # Add transparent colors for fill
  box_colors <- RColorBrewer::brewer.pal(4, "Set2")
  names(box_colors) <- levels(faceted_data_with_outliers$age_group_nccn)
  box_colors_alpha <- alpha(box_colors, 0.7)

  # Create the faceted plot using manual boxplot elements
  p <- ggplot(faceted_data_with_outliers, aes(x = age_group_nccn)) +
    # Manual boxplot rectangles
    geom_crossbar(
      data = box_stats,
      aes(y = median, ymin = q1, ymax = q3, fill = age_group_nccn,
          text = paste("Age Group:", age_group_nccn, "<br>Median:", round(median, 3), "<br>Q1:", round(q1, 3), "<br>Q3:", round(q3, 3))),
      width = 0.5, color = "black", linewidth = 0.25
    ) +
    scale_fill_manual(values = box_colors_alpha, guide = "none") +
    # Manual whiskers
    geom_segment(
      data = box_stats,
      aes(x = as.numeric(age_group_nccn) - 0.2, xend = as.numeric(age_group_nccn) + 0.2,
          y = lower_whisker, yend = lower_whisker),
      color = "black", linewidth = 0.5
    ) +
    geom_segment(
      data = box_stats,
      aes(x = as.numeric(age_group_nccn) - 0.2, xend = as.numeric(age_group_nccn) + 0.2,
          y = upper_whisker, yend = upper_whisker),
      color = "black", linewidth = 0.5
    ) +
    geom_segment(
      data = box_stats,
      aes(x = age_group_nccn, xend = age_group_nccn,
          y = q3, yend = upper_whisker),
      color = "black", linewidth = 0.5
    ) +
    geom_segment(
      data = box_stats,
      aes(x = age_group_nccn, xend = age_group_nccn,
          y = q1, yend = lower_whisker),
      color = "black", linewidth = 0.5
    ) +
    # Normal points
    geom_jitter(
      data = filter(faceted_data_with_outliers, !is_outlier),
      aes(y = expression, fill = age_group_nccn, text = paste("Age Group:", age_group_nccn, "<br>Expression:", round(expression, 3), "<br>Type: Normal")),
      width = 0.2, alpha = 0.4, size = 0.8, shape = 21
    ) +
    # Outlier points
    geom_jitter(
      data = filter(faceted_data_with_outliers, is_outlier),
      aes(y = expression, fill = age_group_nccn, text = paste("Age Group:", age_group_nccn, "<br>Expression:", round(expression, 3), "<br>Type: Outlier")),
      width = 0.2, alpha = 0.7, size = 1.2, shape = 21, stroke = 1, color = "black"
    ) +
    # Add CLD letters
    geom_text(
      data = gene_annotations,
      aes(x = age_group_nccn, y = label_y, label = cld_letter, text = paste("Statistical Group:", cld_letter)),
      inherit.aes = FALSE,
      size = 4, fontface = "bold", color = "black"
    ) +
    # Add sample sizes
    geom_text(
      data = gene_annotations,
      aes(x = age_group_nccn, y = sample_label_y, label = paste0("n=", n), text = paste("Sample Size:", n)),
      inherit.aes = FALSE,
      size = 2.5, color = "gray50"
    ) +
    facet_wrap(~gene, scales = "free_y", ncol = 2) +
    scale_fill_brewer(name = "Age Group", type = "qual", palette = "Set2") +
    labs(
      title = "",
      x = "Age Group (NCCN-IPI Classification)",
      y = "Gene Expression (log2)"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 30, hjust = 1, size = 8),
      axis.text.y = element_text(size = 8),
      axis.title.x = element_text(margin = margin(t = 25, b = 0)),  # Add more top margin to x-axis title
      strip.text = element_text(face = "bold", size = 10),
      strip.background = element_rect(fill = "gray90", color = "gray70"),
      legend.position = "none",  # Remove legend as colors are clear from context
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 0, r = 5, b = 5, l = 5, unit = "pt")  # Remove top margin
    )

  # Convert to interactive plot
  interactive_plot <- ggplotly(p, height = 1800, tooltip = c("text")) %>%
    layout(
      title = "",
      height = 1800,  # Ensure height is applied in layout as well
      margin = list(t = 20, b = 80, l = 60, r = 60)  # Minimal top margin, no title needed
    )

  # Display the plot
  interactive_plot

} else {
  cat("**No significant genes found** to display in the faceted plot.")
}
```

<div class="figure-caption">
**Fig. 1**<br>
Box plots show gene expression distribution by age group for genes with significant Welch's ANOVA results (FDR-adjusted p < 0.05). <br> Compact letter display (CLD) letters (a, b, c) above each boxplot indicate statistical groupings from Games-Howell post-hoc tests within each gene; groups with different letters differ significantly (p < 0.05). <br>
Sample sizes (n) are shown below each age group. <br> Outliers are highlighted in darker borders.
</div>

### Therapy Response by Demographics

Neither gender (p = 1.000) nor age group (p = 0.173) showed significant associations with complete response, although incomplete response proportions did trend upwards as age increased. While neither demographic factor showed prognostic effect on treatment response, the key question whether they modify the gene expression-therapy response association is addressed in the [section below](#gene-demo-interact).

## Gene Expression & Demographic Interactions in Predicting Response {#gene-demo-interact}

### Gene-only Effects

As part of fitting hierarchical models for each gene with either age or gender groups, gene-only models predicting therapy response (i.e. no demographic modification) were also fitted ([Figure 2](#figure2)). One gene out of 21, MYC, displayed significant gene-only effects (LRT FDR-adjusted p-value = 0.010, AIC = 647.57, Chi-square goodness-of-fit p-value = 0.947), with higher expression predicting lower complete response probability. With the lowest AIC score among the 8 MYC models, adding demographic or demographic-MYC interaction did not improve model fit, indicating MYC's prognostic effect is consistent across age and gender groups ([Figure 3a](#figure3)).


<div id="figure2">
**Figure 2. Gene-only Effects on Complete Response**
</div>

```{r gene-effects-forest, echo=FALSE, warning=FALSE, message=FALSE, results='markup'}
# Create forest plot of gene effects from logistic regression

if (nrow(all_gene_effects) > 0) {
  # Prepare data for forest plot (exact approach from script 07)
  gene_or_data <- all_gene_effects %>%
    mutate(
      gene = factor(gene, levels = gene[order(odds_ratio)]),
      significance_category = case_when(
        p_adj < 0.05 ~ "Adjusted significant",
        p.value < 0.05 ~ "Adjusted insignificant",
        TRUE ~ "Insignificant"
      ),
      significance_category = factor(
        significance_category,
        levels = c("Adjusted significant", "Adjusted insignificant", "Insignificant")
      ),
      hover_text = paste0("Gene: ", gene, "<br>",
                         "Odds Ratio: ", round(odds_ratio, 3), "<br>",
                         "95% CI: [", round(or_lower, 3), ", ", round(or_upper, 3), "]<br>",
                         "Raw p-value: ", format.pval(p.value, digits = 3), "<br>",
                         "Adjusted p-value: ", format.pval(p_adj, digits = 3), "<br>",
                         "Status: ", significance_category)
    )

  # Create base forest plot
  plot1_forest <- ggplot(gene_or_data, aes(x = odds_ratio, y = gene)) +
    geom_vline(
      xintercept = 1,
      linetype = "dashed",
      color = "gray40",
      linewidth = 0.6,
      alpha = 0.7
    ) +
    geom_errorbarh(
      aes(xmin = or_lower, xmax = or_upper, color = significance_category),
      height = 0.3,
      linewidth = 0.8,
      alpha = 0.8
    ) +
    geom_point(
      aes(fill = significance_category, text = hover_text),
      size = 3,
      shape = 21,
      color = "white",
      stroke = 0.7,
      alpha = 0.9
    ) +
    scale_x_log10(
      breaks = c(0.1, 0.2, 0.5, 1, 2, 5, 10),
      labels = c("0.1", "0.2", "0.5", "1.0", "2.0", "5.0", "10.0")
    ) +
    scale_color_manual(
      values = c(
        "Adjusted significant" = "#E69F00",
        "Adjusted insignificant" = "#56B4E9",
        "Insignificant" = "#D8BFD8"
      ),
      name = "Significance"
    ) +
    scale_fill_manual(
      values = c(
        "Adjusted significant" = "#E69F00",
        "Adjusted insignificant" = "#56B4E9",
        "Insignificant" = "#D8BFD8"
      ),
      name = "Significance"
    ) +
    labs(
      # title = "Logistic Regression Models - Gene Expression Effects",
      x = "Odds Ratio per Unit Gene Expression (log scale)",
      y = "Gene"
    ) +
    theme_minimal() +
    theme(
      axis.text = element_text(size = 10),
      axis.text.y = element_text(size = 9),
      panel.grid.minor.x = element_blank(),
      legend.position = "none",
      plot.margin = margin(t = 0, r = 5, b = 5, l = 5, unit = "pt")  # Remove top margin
    )

  # Convert to interactive plot (exact approach from script 07)
  plot1_interactive <- ggplotly(plot1_forest, tooltip = "text") %>%
    layout(
      # title = list(
      #   text = "Logistic Regression Models - Gene Expression Effects on Complete Response<br><sub>Orange: Adjusted p-values < 0.05<br>Teal: Adjusted p-values ≥ 0.05, unadjusted p-values < 0.05<br>Light Purple: Unadjusted p-values ≥ 0.05 (insignificant)<br>Confidence interval: 95%</sub>",
      #   font = list(size = 16),
      #   pad = list(t = 20, b = 80)
      # ),
      showlegend = FALSE,
      margin = list(t = 20, b = 80, l = 80, r = 80)  # Minimal top margin, no title needed
    )

  plot1_interactive
} else {
  cat("**No gene effects data available for forest plot.**\n")
}
```

<div class="figure-caption">
**Fig. 2**<br>
Orange: Adjusted significant<br>Blue: Adjusted insignificant<br>Lilac: Insignificant<br>Confidence interval: 95% <BR> MYC is the only gene showing significant gene effect after FDR correction, being well clear of the 1.0 reference (no effect) reference line even when considering its CI error bars.
</div>

### Demographic Modification Effects

Systematic testing of 21 genes across both age and gender yielded 42 gene-demographic models, of which no gender model showed significant effect. Neither gene-gender interaction nor gender main effect models attained significant results for any gene after FDR adjustment. For age, only the CCND2 gene showed significant (LRT FDR-adjusted p-value = 0.006, AIC = 643.12, Chi-square goodness-of-fit p-value = 0.973) effects amongst the interaction models of all 21 genes, and the rest 20 genes showed neither main (additive) nor interactive effects with age. Having the lowest AIC score (min delta = 12.7) amongst the 4 CCND2 models indicate that response completeness is best predicted with gene expression when its interaction with age is factored in.

Clear age-dependent directional effects emerge for CCND2 ([Figure 3b](#figure3)), with higher CCND2 expression levels affecting the response completeness of the age groups differently. The curves for age groups ≤40 and 41-60 and the curves for age groups 61-75 and >75 are going in opposite directions. Complete response probability decreases with CCND2 expression level for the 2 younger groups, while complete response probability increases with CCND2 expression level for the 2 older groups. Further scrutinising the odds ratio[@emmeans] of the 4 age groups ([Figure 4](#figure4)) confirms that both older age groups showed significantly higher complete response odds (61-75 p = 0.014; >75 p = 0.001), and younger age groups (≤40, 41-60) have trends for worse but statistically insignificant odds.

<div id="figure3">
**Figure 3. Logistic Regression Models - Gene Expression Effects on Complete Response**
</div>

```{r predicted-probability-curves, echo=FALSE, warning=FALSE, message=FALSE, results='markup'}
# Function to create predicted probability data (from script 07)
create_prediction_data <- function(model, gene_name, data_subset, age_groups) {
  # Create prediction grid
  gene_range <- seq(
    from = min(data_subset[[gene_name]], na.rm = TRUE),
    to = max(data_subset[[gene_name]], na.rm = TRUE),
    length.out = 100
  )

  # Create all combinations of gene values and age groups
  pred_grid <- expand.grid(
    gene_expr = gene_range,
    age_group_nccn = age_groups
  )
  names(pred_grid)[1] <- gene_name

  # Generate predictions
  pred_grid$predicted_prob <- predict(model, newdata = pred_grid, type = "response")

  return(pred_grid)
}

# Check what models are available for prediction curves
age_groups <- levels(analysis_data$age_group_nccn)

# Plot 2a: MYC - use interaction model if available, otherwise gene model
if (exists("myc_interaction_model") && !is.null(myc_interaction_model)) {
  myc_data_subset <- analysis_data %>% filter(!is.na(MYC), !is.na(age_group_nccn))
  myc_pred_data <- create_prediction_data(myc_interaction_model, "MYC", myc_data_subset, age_groups)
  myc_model_type <- "interaction"
} else if (exists("myc_gene_model") && !is.null(myc_gene_model)) {
  # If no interaction model, use gene model with average age group effect
  myc_data_subset <- analysis_data %>% filter(!is.na(MYC), !is.na(age_group_nccn))
  # For gene-only model, create prediction without age group interaction
  gene_range <- seq(
    from = min(myc_data_subset$MYC, na.rm = TRUE),
    to = max(myc_data_subset$MYC, na.rm = TRUE),
    length.out = 100
  )
  myc_pred_data <- data.frame(
    MYC = rep(gene_range, length(age_groups)),
    age_group_nccn = rep(age_groups, each = length(gene_range))
  )
  myc_pred_data$predicted_prob <- predict(myc_gene_model, newdata = myc_pred_data, type = "response")
  myc_model_type <- "gene_only"
} else {
  myc_pred_data <- NULL
}

# Plot 2b: CCND2 - use interaction model if available, otherwise gene model
if (exists("ccnd2_interaction_model") && !is.null(ccnd2_interaction_model)) {
  ccnd2_data_subset <- analysis_data %>% filter(!is.na(CCND2), !is.na(age_group_nccn))
  ccnd2_pred_data <- create_prediction_data(ccnd2_interaction_model, "CCND2", ccnd2_data_subset, age_groups)
  ccnd2_model_type <- "interaction"
} else if (exists("ccnd2_gene_model") && !is.null(ccnd2_gene_model)) {
  ccnd2_data_subset <- analysis_data %>% filter(!is.na(CCND2), !is.na(age_group_nccn))
  gene_range <- seq(
    from = min(ccnd2_data_subset$CCND2, na.rm = TRUE),
    to = max(ccnd2_data_subset$CCND2, na.rm = TRUE),
    length.out = 100
  )
  ccnd2_pred_data <- data.frame(
    CCND2 = rep(gene_range, length(age_groups)),
    age_group_nccn = rep(age_groups, each = length(gene_range))
  )
  ccnd2_pred_data$predicted_prob <- predict(ccnd2_gene_model, newdata = ccnd2_pred_data, type = "response")
  ccnd2_model_type <- "gene_only"
} else {
  ccnd2_pred_data <- NULL
}

# Create and display Plot 2a: MYC (if data available)
if (!is.null(myc_pred_data)) {
  plot2a_myc <- ggplot() +
    geom_line(
      data = myc_pred_data,
      aes(x = MYC, y = predicted_prob, color = age_group_nccn),
      linewidth = 1.2, alpha = 0.8
    ) +
    geom_point(
      data = myc_data_subset,
      aes(x = MYC, y = as.numeric(response_binary), color = age_group_nccn),
      alpha = 0.4, size = 1.5,
      position = position_jitter(height = 0.02, width = 0)
    ) +
    scale_color_viridis_d(name = "Age Group", option = "plasma") +
    scale_y_continuous(
      limits = c(0, 1),
      labels = scales::percent_format(),
      breaks = seq(0, 1, 0.2)
    ) +
    labs(
      title = "MYC Gene Expression",
      x = "MYC Expression (log2)",
      y = "Probability of Complete Response"
    ) +
    theme_minimal() +
    theme(plot.margin = margin(t = 10, r = 5, b = 5, l = 5, unit = "pt"))  # Remove top margin

  # Convert to interactive plot
  plot2a_interactive <- ggplotly(plot2a_myc) %>%
    layout(
      title = list(
        text = paste0("Figure 3A<br><sub>MYC (",
                     ifelse(myc_model_type == "interaction", "Interaction Model", "Gene Model"), ")</sub>")
      )
    )

  # Display Plot 2a: MYC
  plot2a_interactive
} else {
  cat("**MYC model not available for probability curve plot.**\n")
}

# Create and display Plot 2b: CCND2 (if data available)
if (!is.null(ccnd2_pred_data)) {
  plot2b_ccnd2 <- ggplot() +
    geom_line(
      data = ccnd2_pred_data,
      aes(x = CCND2, y = predicted_prob, color = age_group_nccn),
      linewidth = 1.2, alpha = 0.8
    ) +
    geom_point(
      data = ccnd2_data_subset,
      aes(x = CCND2, y = as.numeric(response_binary), color = age_group_nccn),
      alpha = 0.4, size = 1.5,
      position = position_jitter(height = 0.02, width = 0)
    ) +
    scale_color_viridis_d(name = "Age Group", option = "plasma") +
    scale_y_continuous(
      limits = c(0, 1),
      labels = scales::percent_format(),
      breaks = seq(0, 1, 0.2)
    ) +
    labs(
      title = "CCND2 Gene Expression",
      x = "CCND2 Expression (log2)",
      y = "Probability of Complete Response"
    ) +
    theme_minimal() +
    theme(plot.margin = margin(t = 10, r = 5, b = 5, l = 5, unit = "pt"))  # Remove top margin

  # Convert to interactive plot
  plot2b_interactive <- ggplotly(plot2b_ccnd2) %>%
    layout(
      title = list(
        text = paste0("Figure 3B<br><sub>CCND2 (",
                     ifelse(ccnd2_model_type == "interaction", "Interaction Model", "Gene Model"), ")</sub>")
      )
    )

  # Display Plot 2b: CCND2
  plot2b_interactive
} else {
  cat("**CCND2 model not available for probability curve plot.**\n")
}
```

<div class="figure-caption">
**Fig. 3**<br>
**A.** Logistic regression plot of MYC gene expression against complete response probability, age-interaction model <br>
**B.** Logistic regression plot of CCND2 gene expression against complete response probability, age-interaction model
<br>The MYC gene showed no significant age-interaction effects, contrasting the curves of the different age groups for CCND2.
</div>

<div id="figure4">
**Figure 4. CCND2 Interaction Effects - Age Group Modifying Gene Expression Effects on Complete Response**
</div>

```{r ccnd2-age-slopes, echo=FALSE, warning=FALSE, message=FALSE, results='markup'}
# Create age group slopes analysis for CCND2 interaction model

if (exists("ccnd2_interaction_model")) {
  # Get emtrends data and p-values (exact approach from script 07)
  emtrends_result <- emtrends(
    ccnd2_interaction_model,
    specs = ~age_group_nccn,
    var = "CCND2"
  )

  # Get p-values for each trend using test()
  emtrends_test <- test(emtrends_result) %>%
    as.data.frame()

  # Combine emtrends results with p-values
  plot3_data <- as.data.frame(emtrends_result) %>%
    left_join(
      emtrends_test %>% select(age_group_nccn, p.value),
      by = "age_group_nccn"
    ) %>%
    mutate(
      # Convert slope to odds ratio per unit CCND2 increase
      or_per_unit = exp(CCND2.trend),
      or_lower = exp(asymp.LCL),
      or_upper = exp(asymp.UCL),
      # Significance based on unadjusted p-value only
      significant = p.value < 0.05,
      # ColorBrewer Set2 colors: Orange for significant, Light purple for insignificant
      color_category = ifelse(significant, "Significant", "Insignificant"),
      hover_text = paste0(
        "Age Group: ", age_group_nccn, "<br>",
        "OR per unit CCND2 increase: ", round(or_per_unit, 3), "<br>",
        "95% CI: [", round(or_lower, 3), ", ", round(or_upper, 3), "]<br>",
        "Slope: ", round(CCND2.trend, 3), "<br>",
        "p-value: ", format.pval(p.value, digits = 3)
      )
    ) %>%
    arrange(or_per_unit) %>%
    mutate(age_group_nccn = factor(age_group_nccn, levels = age_group_nccn))

  # Create slopes plot (exact approach from script 07)
  plot3 <- ggplot(plot3_data, aes(x = or_per_unit, y = age_group_nccn)) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "gray50", linewidth = 0.8) +
    geom_errorbarh(
      aes(xmin = or_lower, xmax = or_upper, color = color_category),
      height = 0.3, linewidth = 0.8, alpha = 0.8
    ) +
    geom_point(
      aes(fill = color_category, text = hover_text),
      size = 4, shape = 21, color = "white", stroke = 0.8, alpha = 0.9
    ) +
    scale_x_log10(
      breaks = c(0.5, 0.8, 1.0, 1.2, 1.5, 2.0),
      labels = c("0.5", "0.8", "1.0", "1.2", "1.5", "2.0")
    ) +
    # ColorBrewer Set2 palette (from script 07)
    scale_color_manual(
      values = c("Significant" = "#FF7F00", "Insignificant" = "#CAB2D6"),
      name = "Significance"
    ) +
    scale_fill_manual(
      values = c("Significant" = "#FF7F00", "Insignificant" = "#CAB2D6"),
      name = "Significance"
    ) +
    labs(
      # title = "CCND2 Interaction Effects - Age Group Slopes",
      x = "Odds Ratio per Unit CCND2 (log scale)",
      y = "Age Group (NCCN-IPI)"
    ) +
    theme_minimal() +
    theme(
      axis.text = element_text(size = 10),
      panel.grid.minor = element_blank(),
      legend.position = "none",
      plot.margin = margin(t = 0, r = 5, b = 5, l = 5, unit = "pt")  # Remove top margin
    )

  # Convert to interactive plot (exact approach from script 07)
  plot3_interactive <- ggplotly(plot3, tooltip = "text") %>%
    layout(
      title = list(
        # text = "CCND2 Interaction Effects - Age Group Slopes<br><sub>Orange: Significant slopes, Light Purple: Insignificant slopes</sub>",
        font = list(size = 16)
      ),
      showlegend = FALSE
    )

  plot3_interactive
} else {
  cat("**CCND2 interaction model not available for slopes analysis.**\n")
}
```

<div class="figure-caption">
**Fig. 4**<br>
Odds ratio of age groups <br>
Orange: Significant<br>Lilac: Insignificant<br>Confidence interval: 95% <BR>Both older age groups showed significant modifying effect.
</div>

# Discussion

While gender had displayed potential to influence clinical outcomes[@Habermann2014sexAge, @Hasselblom2006sexAge], the NCCN-IPI did not include gender as the authors found gender did not substantially enhance their model's predictive capability[@zhou2014NCCN-IPI]. The lack of gender-dependent gene expression patterns and gene-modifying effects on prognosis in this analysis further confirms observation. 

Of the big three oncogene drivers of DLBCL, only MYC showed significant (gene-only) effects. MYC's inclusion was in a sense expected as its role as an oncogene is well established[@Dhanasekaran2022MycOncoGene]. Whereas increase in BCL2 expression has been associated with inferior outcomes[@Tsuyama2017BCL2neg] and BCL6 expression bodes well for prognosis [@Hans2004BCL6pos, @Advani2010BCL6pos]. Both genes however have significant LRT p-values when not corrected by FDR, BCL2's gene-only model (unadjusted p = 0.039) and BCL6's interaction model (unadjusted p = 0.037), so perhaps their effects were merely not significant enough for this dataset.

Connecting the two genes of significance of this study, MYC and CCND2, is that the oncoprotein product of MYC actually binds to the promoter of CCND2 *in vivo*[@Bouchard2001MycCCND2], yet within this dataset, the expression of these genes affect different age groups differently. The revelation of CCND2's age modifying effects might actually provide insights to one of the more contested topics in the field, as there are conflicting opinions and associations when it comes to CCND2, where the activity of the gene could indicate better[@Wang2020CCND2Pos] and worse[@Hans2004BCL6pos, @Yi2023CCND2neg] prognoses. Obviously, more work needs to be conducted to establish this modifying effect of age-CCND2 on prognosis is robust and not spurious.

In the end, it has to be acknowledged that this study is not without flaws. The available dataset, especially gene expression data, was pre-selected for publication, not for the exploratory analysis of demographic effects on the prognostic powers of genomic drivers. The dataset also lacked ethnicity information, when it was likely patients from different continents were included. It would also be of great boon to the study to be able to benchmark the analysis here with Reddy's genomic risk model. Unfortunately, the (hyper-)parameters required to rebuild such model along with the interactive webtool for this model are no longer accessible. This further highlights reproducibility in cancer research[@Begley2012cancerResearchRepro] and bioinformatics[@Ziemann2023bioinformatics] in general, and make me appreciate the emphasis of robust replicability our lecturers had imparted on us during the first module.

# Conclusion

This analysis of 775 DLBCL patients discovered 10 genes BCL2, BLNK, MYBL1, SH3BP5, ITPKB, CCND2, PTPN1, BMF, FUT8 and LMO2, showed age-dependent gene expression levels. One gene CCND2 showed modifying effects with age on predicting therapy outcomes, and the MYC gene showed gene only effects with age. The discovery of CCND2's modifying effect could partially resolve the conflicting accounts of how CCND2 activity associate with prognosis. This is an exciting find that still needs work to replicate and validate.

# References

::: {#refs}
:::