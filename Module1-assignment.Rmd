---
title: "Effects of age and gender on using gene expression markers as prognostic markers for diffuse large B cell lymphoma (DLBCL)"
author: "cyy36@cam.ac.uk"
date: "6/11/2025"
output:
  html_document:
    css: dark-theme.css
    highlight: breezedark
    toc: yes
# toc_float: yes
bibliography: references.bib
---

<center>
![](https://onlinecareeraccelerators.pace.cam.ac.uk/hubfs/CAM%20DS%20PACE/Professional%20and%20Continuing%20Education_V_reversed%20colour%201.svg)
</center>


<h3 style="text-align: center;">MSt Healthcare Data Science</h2>

#### Authentication of practice

|   |   |
|---|---|
|I confirm that I have fully read and understood the [assignment brief](https://vle.pace.cam.ac.uk/mod/page/view.php?id=2419694) for this module.| **Y** |

#### Details

|   |   |
|---|---|
|Name: Chung Yan|Surname: Yu|
|Submission Date| 19-10-25|
|Word Count: whole assignment including codes| |
|Word Count: main body excluding abstract, references and supplementary materials| |

#### Permission to share your assignment: delete as appropriate

I do give permission to share my assignment with future MSt participants.

#### University statement of originality

This assignment is the result of my own work and includes nothing which is the outcome of work done in collaboration except as declared in the Preface and specified in the text. It is not substantially the same as any that I have previously submitted for a degree or diploma or other qualification at the University of Cambridge or any other university or similar institution, or that is being concurrently submitted, except as declared in the Preface and specific in the text. I further state that no substantial part of my Portfolio has already been submitted, nor is being concurrently submitted for any such degree, diploma or other qualification at the University of Cambridge or any other university or similar institution except as declared in the Preface and specified in the text.

|   |   |
|---|---|
|I confirm the statement of originality as above| **Y** |


#### Questions for reflection

Self-assessment is an important aspect of feedback literacy, which is, in turn, key to the development of expertise. As you proceed through the MSt Healthcare data science programme, we hope that you will make use of the following prompts to assess your own work on assignments. Specific assignment briefs will likely indicate which of these to address for which assessments, but, in general, we expect you to respond to one or two for each assignment on your course. 

For each of the questions, do not spend too long answering – keep it brief. For each question you answer, limit yourself to no more than three items. And please remember, this is optional and developmental: these cover sheets are designed to create space for self-assessment and feedback dialogue, rather than additional assignment workload.

1. Which aspects of this assignment are you most uncertain about and/or would most like to receive feedback on?
2. What elements are you left pondering after this assignment that you would like to discuss further?
3. How have you incorporated feedback from peers and tutors into this assignment?
4. How, and to what extent, have you been able to incorporate feedback on previous course work into this assignment? 
5. Using the wording in the rubric, how would you describe the quality of the different aspects of your work?

### Declaration of the use of generative AI

|   |   |
|---|---|
|Which permitted use of generative AI are you acknowledging?|Semantic search of literature and notes, outline creation, code debugging, informed feedback|
|Which generative AI tool did you use (name and version)?|Claude Code v2.0.3x (the version likely changed over usage), Claude Desktop v1.0.3x with PubMed Connector, M365 CoPilot|
|What did you use the tool for?|Searching for relevant journal publications, sanity check on coding strategies, collating notes in my Obsidian vault, debugging code by parsing error messages|
|How have you used or changed the generative AI's output|E.g. my collated notes always stay in point form so that I write out the paragraphs in my own words. Feedback provided by the GenAI models are weighed and assessed before being acted on.|

# Abstract

Diffuse large B cell lymphoma (DLBCL) is the most common non-Hodgkin lymphoma, with prognosis influenced by diverse factors ranging from demographic features (age, gender) to integrated scoring systems such as the International Prognostic Index (IPI), and genetic mutations altering gene expression levels. Oncogenes MYC, BCL2 and BCL6 emerged with strong associations with DLBCL, and further studies have identified over 150 genetic drivers of this disease. Yet how demographic factors interact with this expanding catalogue of genetic markers remains understudied. This study analysed clinical and genomic data from 1001 DLBCL patients to investigate whether age and gender modify the prognostic associations between gene expression markers and clinical outcomes.

```{r setup, include=FALSE}
# Set chunk options: hide all code, outputs, messages, warnings, and errors
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      results = 'hide', error = FALSE)

# Suppress all output during package installation and loading
suppressMessages(suppressWarnings({

  # Package installation (silent)
  if(!require(tidyverse, quietly = TRUE)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
  if(!require(knitr, quietly = TRUE)) install.packages("knitr", repos = "http://cran.us.r-project.org")
  if(!require(DT, quietly = TRUE)) install.packages("DT", repos = "http://cran.us.r-project.org")
  if(!require(readxl, quietly = TRUE)) install.packages("readxl", repos = "http://cran.us.r-project.org")
  if(!require(httr, quietly = TRUE)) install.packages("httr", repos = "http://cran.us.r-project.org")
  if(!require(here, quietly = TRUE)) install.packages("here", repos = "http://cran.us.r-project.org")
  if(!require(kableExtra, quietly = TRUE)) install.packages("kableExtra", repos = "http://cran.us.r-project.org")

  # Load packages (silent)
  library(tidyverse)
  library(knitr)
  library(DT)
  library(readxl)
  library(httr)
  library(here)
  library(kableExtra)

}))
```

# Introduction

```{r data-loading, cache = TRUE}
# Silent data loading with fallback mechanism
# Data source tracking for inline text reference

# Define data source URLs
# Default URL, direct from ScienceDirect
direct_url <- "https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx"
# Backup URL, from this GitHub repository
repo_url <- "https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc1-ClinicalInformation.csv"

# Initialise variables for tracking data source
clinical_data <- NULL
data_source_type <- ""  # For storing inline text reference on which URL was used

# Suppress all output during data loading
suppressMessages(suppressWarnings({

  # Attempt 1: Load from original ScienceDirect URL
  tryCatch({
    temp_file <- tempfile(fileext = ".xlsx")
    download.file(direct_url, temp_file, mode = "wb", quiet = TRUE)

    # Verify file downloaded and is readable
    if (file.exists(temp_file) && file.size(temp_file) > 0) {
      clinical_data <- read_excel(temp_file, sheet = "Clinical Information", skip = 3)

      # Verify data loaded properly, i.e. matches known dimensions
      if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
        data_source_type <- "original"
      } else {
        stop("Wrong dimensions in the ScienceDirect data for clinical information dataset") # Corresponds to the dimension check
      }
    } else {
      stop("Clinical information from Table S1 failed to download") # Corresponds to the file exist and file size != 0 check
    }

  }, error = function(e) {
    clinical_data <<- NULL  # Ensure NULL for fallback
  })

  # Attempt 2: Fallback to processed backup dataset
  if (is.null(clinical_data)) {
    tryCatch({
      clinical_data <- read_csv(repo_url, show_col_types = FALSE)

      # Verify backup data loaded properly, the same dimension checking as above
      if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
        data_source_type <- "backup"
      } else {
        stop("Wrong dimensions in the GitHub backup clinical information data")
      }

    }, error = function(e) {
      clinical_data <<- NULL  # Ensure NULL for next fallback
    })
  }

  # Attempt 3: Check for local CSV file in data/ folder
  if (is.null(clinical_data)) {
    tryCatch({
      local_file_path <- here("data", "mmc1-ClinicalInformation.csv")

      if (file.exists(local_file_path)) {
        clinical_data <- read_csv(local_file_path, show_col_types = FALSE)

        # Verify local data loaded properly, same dimension checking
        if (nrow(clinical_data) == 1001 && ncol(clinical_data) == 35) {
          data_source_type <- "local"
        } else {
          stop("Wrong dimensions in local clinical information data file")
        }
      } else {
        stop("Local clinical information data file not found")
      }

    }, error = function(e) {
      # If all three attempts fail, create empty dataset to prevent knitting errors
      clinical_data <<- data.frame()
      data_source_type <<- "all-failed"
    })
  }

}))

# Create unified inline text variables for both datasets
# Assume both datasets have same source availability (same host, same access restrictions)
if (data_source_type == "original") {
  unified_data_source_text <- "both datasets were loaded directly from ScienceDirect's supplementary materials: [S1 Table](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) (clinical data) and [S2 Table](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx) (gene expression data)."
} else if (data_source_type == "backup") {
  unified_data_source_text <- "the ScienceDirect links were unavailable, so both datasets were loaded from processed copies in [this coursework's repository](https://github.com/joelyu/HDS-W1): [clinical data](https://github.com/joelyu/HDS-W1/blob/main/data/mmc1-ClinicalInformation.csv) and [gene expression data](https://github.com/joelyu/HDS-W1/blob/main/data/mmc2-GeneExpression.csv)."
} else if (data_source_type == "local") {
  unified_data_source_text <- "both online sources were unavailable, so both datasets were loaded from local copies in the `data/` folder."
} else if (data_source_type == "all-failed"){
  unified_data_source_text <- "all data sources (ScienceDirect, GitHub repository, and local files) are unavailable. Please download both CSV files from [this coursework's repository](https://github.com/joelyu/HDS-W1/tree/main/data) and place them in the `data/` folder, then re-knit this document."
}

# Store row and column counts for MMC1 (Clinical data)
if (data_source_type == "all-failed") {
  # Hardcode expected values if all data sources fail
  n_patients_clinical <- 1001  # Number of patients in clinical dataset
  n_clinical_variables <- 35   # Number of clinical variables (including patient ID)
} else {
  n_patients_clinical <- ifelse(is.null(clinical_data), 0, nrow(clinical_data))
  n_clinical_variables <- ifelse(is.null(clinical_data), 0, ncol(clinical_data))
}

# Load MMC2 (Gene Expression) data with same fallback mechanism
suppressMessages(suppressWarnings({

  # Define data source URLs for MMC2
  direct_url_mmc2 <- "https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx"
  repo_url_mmc2 <- "https://raw.githubusercontent.com/joelyu/HDS-W1/refs/heads/main/data/mmc2-GeneExpression.csv"

  # Initialise variables for tracking MMC2 data source
  gene_expression_data <- NULL
  data_source_type_mmc2 <- ""

  # Attempt 1: Load from original ScienceDirect URL
  tryCatch({
    temp_file_mmc2 <- tempfile(fileext = ".xlsx")
    download.file(direct_url_mmc2, temp_file_mmc2, mode = "wb", quiet = TRUE)

    # Verify file downloaded and is readable
    if (file.exists(temp_file_mmc2) && file.size(temp_file_mmc2) > 0) {
      gene_expression_data <- read_excel(temp_file_mmc2, sheet = "Gene Expression", skip = 3)

      # Verify data loaded properly, i.e. matches known dimensions (775 rows × 21 columns)
      if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
        data_source_type_mmc2 <- "original"
      } else {
        stop("Wrong dimensions in the ScienceDirect Gene Expression dataset")
      }
    } else {
      stop("Gene expression data from Table S2 failed to download")
    }

  }, error = function(e) {
    gene_expression_data <<- NULL  # Ensure NULL for fallback
  })

  # Attempt 2: Fallback to processed backup dataset
  if (is.null(gene_expression_data)) {
    tryCatch({
      gene_expression_data <- read_csv(repo_url_mmc2, show_col_types = FALSE)

      # Verify backup data loaded properly, same dimension checking
      if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
        data_source_type_mmc2 <- "backup"
      } else {
        stop("Wrong dimensions in the GitHub backup gene expression data")
      }

    }, error = function(e) {
      gene_expression_data <<- NULL  # Ensure NULL for next fallback
    })
  }

  # Attempt 3: Check for local CSV file in data/ folder
  if (is.null(gene_expression_data)) {
    tryCatch({
      local_file_path_mmc2 <- here("data", "mmc2-GeneExpression.csv")

      if (file.exists(local_file_path_mmc2)) {
        gene_expression_data <- read_csv(local_file_path_mmc2, show_col_types = FALSE)

        # Verify local data loaded properly, same dimension checking
        if (nrow(gene_expression_data) == 775 && ncol(gene_expression_data) == 21) {
          data_source_type_mmc2 <- "local"
        } else {
          stop("Wrong dimensions in local gene expression data file")
        }
      } else {
        stop("Local gene expression data file not found")
      }

    }, error = function(e) {
      # If all three attempts fail, create empty dataset to prevent knitting errors
      gene_expression_data <<- data.frame()
      data_source_type_mmc2 <<- "all-failed"
    })
  }

}))

# Note: Using unified data source text based on MMC1 status
# Both datasets from same host, so assume same availability

# Store row and column counts for MMC2 (Gene Expression data)
if (data_source_type_mmc2 == "all-failed") {
  # Hardcode expected values if all data sources fail
  n_patients_expression <- 775    # Number of patients with gene expression data
  n_total_columns <- 21           # Total columns: 1 patient ID + 1 RNA check + 19 genes
  n_genes_measured <- 19          # Number of genes with expression measurements
} else {
  n_patients_expression <- ifelse(is.null(gene_expression_data), 0, nrow(gene_expression_data))
  n_total_columns <- ifelse(is.null(gene_expression_data), 0, ncol(gene_expression_data))
  n_genes_measured <- ifelse(is.null(gene_expression_data), 0, ncol(gene_expression_data) - 2)  # Subtract patient ID and RNA check columns
}
```

Diffuse large B cell lymphoma (DLBCL) is the most common type of aggressive non-Hodgkin's lymphoma (NHL) [@blood1997; @WANG2023], with a wide range of factors contributing to prognosis. For a comparable and more comprehensive pre-treatment prognosis model, the international prognostic index (IPI) emerged as a standardised model for DLBCL and other aggressive NHLs [@shipp1993], combining 5 factors: age, Ann Arbor stage classification, ECOG Performance Status, serum lactate dehydrogenase level and the number of extranodal sites of disease. By pooling factors together, the IPI outperformed simple disease stage classification models such as Ann Arbor. As prognosis models improved, so did treatment. The first generation chemotherapy of cyclophosphamide, doxorubicin, vincristine, and prednisone (CHOP) had a cure rate of 30-35% [@Fisher1993CHOP]. With the addition of rituximab to the regimen (R-CHOP) and other advances, DLBCL becomes curable for more than 60% of patients [@johnson2012doublehit]. 

While age is incorporated into the IPI, other demographic factors such as gender are not, despite established evidence for their prognostic involvement. Males demonstrate higher hazard ratios [@Carella2013male] and gender-associated pharmacokinetic differences in rituximab lead to worse treatment responses in males [@Habermann2014sexAge]. These demographic effects raise questions about whether risk factors perform uniformly across patient subgroups. Beyond demographic and clinical factors, a series of genetic alterations have emerged as strong prognostic markers: BCL2 [@Gascoyne1997BCL2], BCL6 [@LoCoco1994BCL6] and MYC [@ChenevixTrench1986MYC]. These changes are observed at both the genotypic and phenotypic levels, as translocation mutations and protein overexpression respectively [@Petrich2014MYCReview]. Furthermore, patients with varying combinations of these alterations have shown worse responses to R-CHOP treatments, highlighting the clinical relevance of genomic profiling.

With the advent of machine learning methods came attempts to construct models based on clinical and genomic data. @reddy2017paper performed whole exome and transcriptome sequencing in 1001 DLBCL patients, identifying 150 genetic drivers including BCL2, BCL6, and MYC alongside numerous newly characterised candidates. By combining genotypic alterations, gene expression data and cell-of-origin classification, they developed a genomic risk model that outperformed the IPI. However, the potential for demographic factors to modify these genomic associations remains understudied. Given that age and gender both demonstrate prognostic significance and influence treatment response, it remains unknown whether genomic risk markers perform uniformly across demographic subgroups. This study addresses this gap by investigating whether age and gender modify the prognostic associations between gene expression markers and clinical outcomes in DLBCL.

Here the same datasets [@reddy2017dataset] from the genomic risk model study by @reddy2017paper are utilised, specifically their clinical information dataset from [Supplementary Table S1](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) and gene expression dataset from [Supplementary Table S2](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx). The clinical information dataset comprises `r n_patients_clinical` DLBCL patients with `r n_clinical_variables` variables. Patients are recorded with anonymised IDs with the variables of interest to us being gender (binary: F/M), response to initial therapy (categorical: Complete response, Partial response, No response), age at diagnosis (continuous), overall survival years (continuous), censored (binary: 0 indicating death observed, 1 indicating patient alive at last follow-up), the expression level of MYC, BCL2 and BCL6 genes based on log2 transformation of RNA-sequencing Fragments per kilobase (FPKM) value. These columns are highlighted and used in further analysis not only due to their relevance, but also their relative completeness. The gene expression dataset comprises the gene expression level (log2 transformed again) of `r n_genes_measured` genes (1 gene BCL6 is also recorded in the clinical information dataset) for `r n_patients_expression` patients.

# Methods

```{r data-integration, cache = TRUE}
# Combine MMC1 and MMC2 datasets via patient ID matching

# Select key variables from clinical dataset (MMC1)
clinical_selected <- clinical_data %>%
  select(
    sample_id = `Sample  ID`,
    gender = Gender,
    response_therapy = `Response to initial therapy`,
    age_at_diagnosis = `age at diagnosis`,
    os_years = `Overall Survival years`,
    censored = Censored,
    log2_myc = `log2 MYC expr`,
    log2_bcl2 = `log2 BCL2 expr`,
    log2_bcl6_mmc1 = `log2 BCL6 expr`
  )

# Select gene expression data from MMC2 (all genes except Samples column)
expression_selected <- gene_expression_data %>%
  select(-Samples) %>%
  rename(log2_bcl6_mmc2 = BCL6) %>%  # Rename for validation
  bind_cols(sample_id = gene_expression_data$Samples, .)

# Inner join to keep only patients with both clinical and expression data
combined_data <- clinical_selected %>%
  inner_join(expression_selected, by = "sample_id") %>%
  mutate(
    age_group_nccn = case_when(
      age_at_diagnosis <= 40 ~ "≤40 years",
      age_at_diagnosis <= 60 ~ "41-60 years",
      age_at_diagnosis <= 75 ~ "61-75 years",
      age_at_diagnosis > 75 ~ ">75 years",
      TRUE ~ NA_character_
    ),
    age_group_nccn = factor(age_group_nccn,
                           levels = c("≤40 years", "41-60 years", "61-75 years", ">75 years"))
  )

# Validate BCL6 consistency and keep one version
bcl6_validation <- combined_data %>%
  filter(!is.na(log2_bcl6_mmc1), !is.na(log2_bcl6_mmc2)) %>%
  mutate(bcl6_difference = abs(log2_bcl6_mmc1 - log2_bcl6_mmc2))

# Remove duplicate BCL6 column and rename
combined_data <- combined_data %>%
  select(-log2_bcl6_mmc2) %>%
  rename(log2_bcl6 = log2_bcl6_mmc1)

# Store dimensions for inline text
n_final_patients <- nrow(combined_data)
n_final_variables <- ncol(combined_data)
```

The datasets are available via Elsevier's open access [license](https://www.elsevier.com/about/policies-and-standards/open-access-licenses/elsevier-user), patient clinical information and tumours were obtained by @reddy2017paper from 
 are downloaded as Excel files directly from their links on ScienceDirect page for @reddy2017paper's publication, [Table S1](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc1.xlsx) and [Table S2](https://ars.els-cdn.com/content/image/1-s2.0-S0092867417311212-mmc2.xlsx) using the `download.file` function from R's `utils` package [@R-base] and read via the `readxl` package [@readxl].

For this knitted HTML document, `r unified_data_source_text`




# Results


# Conclusion

# Discussion

# Conclusion

# References

::: {#refs}
:::